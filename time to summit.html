<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Time to Summit</title>
		<script type="text/javascript" src="d3.js"></script> 
		<style type="text/css">
            body {
                background-color:lightyellow; 
                font-family:courier;
            }
			
		</style>
		<p>Take a guess!  </p>
		<p>How long it takes from the base camp to the summit?  </p>
		<p>Arrange the gold circle as you think and click "Submit" to check</p>
		<p>Submit</p>
	</head>
	<body>
<script>
	
	var w = 900;
	var h = 600;
	var padding = 40;
	
	var chart1 = d3.select("body")
	.append("svg")
	.attr("width",w)
	.attr("height",h)
	
	//creare movable circles
	
	var radius = 10;

	var circles = [5350,6100,6400,7350,7900,8850]

       d3.selectAll("svg")
            .selectAll("circle")
            .data(circles)
            .enter()
            .append("circle")
            .attr("cx", function (d) { return padding; })
            .attr("cy", function (d) { return h-(d-5350)/3500*(h-2*padding)-padding; })
            .attr("r", radius)
            .style("fill", "gold")
            .on("mouseover", function (d) {d3.select(this).style("cursor", "move");})
            .on("mouseout", function (d) {})
            .call(d3.drag()
                  .on("start", dragstarted)
                  .on("drag", dragged)
                  .on("end", dragended)
                  );

        function dragstarted(d) {
            d3.select(this).raise().classed("active", true);
        }

        function dragged(d) {
            d3.select(this).attr("cx", d.x = d3.event.x)
            //!!!!IF YOU COMMENT OUT BELOW YOU WILL ONLY BE ABLE TO DRAG HORIZONTALLY
            //.attr("cy", d.y = d3.event.y);
        }

        function dragended(d) {
            d3.select(this).classed("active", false);
        }
		
var xScale = d3.scaleLinear()
         .domain([0, 80])
		 //.domain([d3.min(dataset, function(d){ return d[0]; }), d3.max(dataset, function(d) { return d[0]; })])
		 .range([padding, w - padding * 2]);
		 
var yScale = d3.scaleLinear()
		 //.domain([d3.min(dataset, function(d){ return d[1]; }), d3.max(dataset, function(d) { return d[1]; })])
		 .domain([5350,8850])
		 .range([h - padding, padding]);
		
	   var line = d3.line()
	   .x(function(d,i){
		   return xScale(d[0])
	   })
	   .y(function(d,i){
		   return yScale(d[1])
	   })
	   .curve(d3.curveMonotoneX)
	   
	   var area = d3.area()
	   .x(function(d,i){
		   return xScale(d[0])
	   })
	   .y0(function(d,i){
		   return yScale(d[1])
	   })
	   .y1(function(d,i){
	   	return h-padding
	   })
	   .curve(d3.curveMonotoneX)
		
	   legend=[[[0,5350],[80,5350]],[[0,6100],[80,6100]],[[0,6400],[80,6400]],[[0,7350],[80,7350]],[[0,7900],[80,7900]],[[0,8850],[80,8850]]]
	   
	   //draw x Axis and legends
	   
	   for(var i=0; i<legend.length; i++){
		   legendinside = legend[i]
		   d3.select("svg")
		   .append("path")
		   .data([legendinside])
		   .attr("d",line)
		   .attr("fill", "none")//styles the line with attr
		   .attr("class", "lines")
		   .attr("stroke","black")
		   .attr("opacity",0.5)
		   .style("stroke-dasharray", ("1, 1"));
		   
		   innerdataset = legend
		   d3.select("svg")
		   .selectAll("text")
		   .data(innerdataset)
		   .enter()
		   .append("text")
		   .text(function(d,i){
			   //console.log(d[0][1])
		   	return d[0][1] + "m"
		   }) 
		   .attr("x", w-padding)
		   .attr("y", function(d,i){
			   console.log(yScale(d[0][1]))
		   	return yScale(d[0][1])
			})
		   .attr("font-family", "sans-serif")
		   .attr("font-size", "11px")
		   .attr("fill", "black");
		}
	   
		var formatDay = function(d) {
				return "day" + " " + d; 
					 }
		   
		   var xAxis = d3.axisBottom()
					 .scale(xScale)
					 .ticks(10)
			         .tickFormat(formatDay);
			
					 
		   var yAxis = d3.axisLeft()
					 .scale(yScale)
					 .ticks(20);
					 
					 d3.select("svg")
					 .append("g")
					 .attr("class","axis")
					 .attr("transform","translate(0,"+ (h-padding) +")")
					 .call(xAxis)
					 
					 d3.select("svg")
					 .append("g")
					 .attr("class","axis")
					 .call(xAxis)
		   /*svg.append("g")
					 .attr("class","axis")
					 .attr("transform","translate("+padding+",0)")
					 .call(yAxis)*/
		
//click a button to trigger the illustratio of real data
	
	d3.selectAll("p")
	.on("click", function() {
		//LOAD DATA
		d3.csv("N_Col_NE_Ridge_6.csv")
		//d3.csv("route_data.csv")
		.then(function(data) {
			var parsedData = parseRoute(data)
			//console.log(parsedData)
			
			for(var i=0; i<parsedData.length; i++){
				
				time = i
				
				dataset = parsedData[i];
				
				t = 500
				 
				//dot control
				svg.selectAll(".new")
				   .data(dataset)
				   .enter()
				   .append("circle")
				   .attr("class", "new")
				   .attr("cx", function(d) {
					    
				   		return xScale(d[0]);
				   })
				   .attr("cy", function(d) {
				   		return yScale(d[1]);
				   })
				   .attr("fill","gold")
				   .attr("r", 10)
				   .attr("class", "doned")
				   .attr("opacity",0)
				   .transition()
				   .duration(t)
				   .delay( function(d,i) {  return time * t})
				   .attr("opacity",0.8)
				   .attr("r", 2)
				   .attr("fill","gold")
				   
				   //area control
				   svg.append("path")
				   .data([dataset])
				   .attr("d",area)
				   .attr("fill", "none")//styles the line with attr
				   //.attr("class", "lines")
				   .attr("stroke","none")
				   .attr("opacity",0)
				   .transition()
				   .duration(t)
				   .delay( function(d,i) {  return time * t})
				   .attr("opacity",0.05)
				   .attr("fill","grey")
				   
				   //line control
				   svg.append("path")
				   .data([dataset])
				   .attr("d",line)
				   .attr("fill", "none")//styles the line with attr
				   .attr("class", "lines")
				   .attr("stroke","gold")
				   .attr("opacity",0)
				   .transition()
				   .duration(t)
				   .delay( function(d,i) {  return time * t})
				   .attr("opacity",1)
				   .attr("stroke-width",0.5)
				   .attr("fill","none")
			   }
			   
			   
		   })
			   
			   
		const _MS_PER_DAY = 1000 * 60 * 60 * 24;

		// a and b are javascript Date objects
		function dateDiffInDays(a, b) {
		  // Discard the time and time-zone information.
		  const utc1 = Date.UTC(a.getFullYear(), a.getMonth(), a.getDate());
		  const utc2 = Date.UTC(b.getFullYear(), b.getMonth(), b.getDate());

		  return Math.floor((utc2 - utc1) / _MS_PER_DAY);
		}
	
		//create svg
		var svg = d3.select("body")
		.append("svg")
		.attr("width", w)
		.attr("height", h)
		.attr("opacity", 1)
		.attr("transform","translate(0,"+ (-h - 5) +")");
		
        function parseRoute(data){
            
            var formatted = []//Array to store new organized data
            var simplified = []
			
            for(var i in data){
                var year = data[i].year
                formatted[i]=[]
                simplified[i]=[]//each line is an array
                if(data[i].route!=undefined){
                    var route = data[i].route.split("),").join(")").split(")") // get each route data one by one
                    //console.log(route)
                    var parsedRoute = []
                    for(var r in route){
                        // r is the number of elements in each route array
                        var complete = true
                        var entry = route[r] //entry is a string
                        var station = entry.split("(")[0]
                        var stationRecord = entry.split("(")[1]
                        if(stationRecord!=undefined){
                            var sRList = stationRecord.split(",")
                            if(sRList.length==2){
								var parser2 = d3.timeParse("%d/%m/%Y")
								var dateconverted = sRList[0] +"/"+ year
                                var date = parser2(dateconverted)
                                var elevation = sRList[1]
                            }else{
                                
                                //when there is a missing value, then "NA" is substituted
                                //you will have to decide how to draw
                                if(stationRecord.includes("/")){
                                    var date = parser2(stationRecord +"/"+ year)
									if(station == "Smt")
                                    var elevation = 8850
										else complete = false
                                }else{
                                    var elevation = stationRecord
                                    var date = "NA"
									var complete = false
                            
                                }
                            }
							
							if(date != "NA" && date != null){
							   if(r==0){
								   var day = 0
							   }
							   else
								   if(formatted[i][0][1] != "NA" && formatted[i][0][1] != null)
								   var day = dateDiffInDays(formatted[i][0][1],date)
								   
							}
							else
								{var day = "null"
								var complete = false}
							
                            //you may need to put this in different formats
                            formatted[i].push([station, date, elevation,year])
							//console.log(complete)
							if(complete == true)
							simplified[i].push([day, parseInt(elevation)])
							
							else{
							    //simplified[i].push([0,8850])
								
							}
                        }
                    }
					if(complete == false)
						simplified[i]=null
						complete = true
					
                }
            }
            return simplified
        }
		

	})
		

		</script>  
	</body>
</html>